#!/bin/bash

# List of Pokémon to fetch
POKEMONS=("Bulbasaur" "Ivysaur" "Venusaur" "Charmander" "Charmeleon")
LOG_FILE="fetch_log.txt"
ERROR_FILE="errors.txt"
URL_PREFIX="pokeapi.co/api/v2/pokemon/"

# Clear files at the start
> "$LOG_FILE"
> "$ERROR_FILE"

# Set up trap to handle script termination and clean up background jobs
trap 'echo "Terminating jobs..."; kill $(jobs -p) 2>/dev/null; exit' INT

echo "Starting parallel fetch for ${#POKEMONS[@]} Pokémon..."

for POKEMON in "${POKEMONS[@]}"; do
    (
        LOWER_NAME=$(echo "$POKEMON" | tr '[:upper:]' '[:lower:]')
        API_URL="${URL_PREFIX}${LOWER_NAME}/"
        OUTPUT_FILE="${LOWER_NAME}.json"

        # Fetch data following redirects (-L)
        http_code=$(curl -sL -o "$OUTPUT_FILE" -w "%{http_code}" "$API_URL")

        if [ "$http_code" -eq 200 ]; then
            echo "Fetched $POKEMON" >> "$LOG_FILE"
        else
            echo "Failed: $POKEMON (HTTP $http_code)" >> "$ERROR_FILE"
            rm -f "$OUTPUT_FILE"
        fi
    ) & 
done

# Use 'jobs' to list currently running background processes
echo "Currently active background processes:"
jobs -l

# Wait for all background processes to complete
echo "Waiting for all processes to finish..."
wait

echo "All processes complete. Check $LOG_FILE for results."
echo "Fetch process finished."